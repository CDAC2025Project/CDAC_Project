 #include "oled.h"
#include "font6x8.h"

/* small delay used for reset/timing */
static void oled_delay_short(void) { for (volatile int i = 0; i < 20000; i++); }
static void oled_delay_long(void)  { for (volatile int i = 0; i < 400000; i++); }

void OLED_GPIO_Init(void)
{
    RCC->AHB1ENR |= RCC_AHB1ENR_GPIOBEN;

    GPIOB->MODER &= ~((3U << (0*2)) | (3U << (1*2)));
    GPIOB->MODER |=  ((1U << (0*2)) | (1U << (1*2)));

    GPIOB->OTYPER &= ~((1U<<0) | (1U<<1));
    GPIOB->OSPEEDR |= (3U << (0*2)) | (3U << (1*2));
    GPIOB->PUPDR &= ~((3U << (0*2)) | (3U << (1*2)));

    OLED_DC_LOW();
    OLED_RES_HIGH();
}

void OLED_SendCommand(uint8_t cmd)
{
    OLED_DC_LOW();
    SpiCSEnable();
    SpiTransmit(cmd);
    SpiCSDisable();
}

void OLED_SendData(uint8_t data)
{
    OLED_DC_HIGH();
    SpiCSEnable();
    SpiTransmit(data);
    SpiCSDisable();
}

void OLED_SetCursor(uint8_t page, uint8_t column)
{
    OLED_SendCommand(0xB0 + (page & 0x07));
    OLED_SendCommand(column & 0x0F);
    OLED_SendCommand(0x10 | ((column >> 4) & 0x0F));
}

void OLED_Init(void)
{
    OLED_GPIO_Init();
    SpiInit();

    OLED_RES_LOW();
    oled_delay_short();
    OLED_RES_HIGH();
    oled_delay_long();

    OLED_SendCommand(0xAE);             // Display OFF
    OLED_SendCommand(0xD5); OLED_SendCommand(0x80); // Clock
    OLED_SendCommand(0xA8); OLED_SendCommand(0x3F); // Multiplex
    OLED_SendCommand(0xD3); OLED_SendCommand(0x00); // Offset
    OLED_SendCommand(0x40);             // Start line
    OLED_SendCommand(0x8D); OLED_SendCommand(0x14); // Charge pump
    OLED_SendCommand(0x20); OLED_SendCommand(0x00); // Horizontal addressing
    OLED_SendCommand(0xA1);             // Segment remap
    OLED_SendCommand(0xC8);             // COM scan
    OLED_SendCommand(0xDA); OLED_SendCommand(0x12); // COM pins
    OLED_SendCommand(0x81); OLED_SendCommand(0xCF); // Contrast
    OLED_SendCommand(0xD9); OLED_SendCommand(0xF1); // Precharge
    OLED_SendCommand(0xDB); OLED_SendCommand(0x40); // VCOMH
    OLED_SendCommand(0xA4);             // Entire ON
    OLED_SendCommand(0xA6);             // Normal display
    OLED_SendCommand(0xAF);             // Display ON

    OLED_Clear();
}

void OLED_Clear(void)
{
    for (uint8_t page = 0; page < 8; page++)
        OLED_ClearPage(page);
}

void OLED_ClearPage(uint8_t page)
{
    OLED_SetCursor(page, 0);
    for (uint8_t col = 0; col < 128; col++)
        OLED_SendData(0x00);
}

void OLED_PrintChar(char c)
{
    if (c < 32 || c > 127) c
